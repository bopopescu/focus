{% extends "base.html" %}
{% load auth %}
{% load i18n %}
{% load thumbnail %}

{% block extrahead %}
{% endblock %}

{% block submenu %}
{% endblock %}


{% block sidebar %}
    {% include "tickets/sidebar.html" %}
{% endblock %}

{% block maincontent %}

    <style type="text/css">
        .visibility_form {
            color: red;
        }
        .public_visibility {
            color: green;
        }
    </style>


    <div class="ticket_info">

        <h2> {% trans "Ticket" %} #{{ ticket.id }} - {{ ticket.title }}</h2>

        <div class="ticket_details">
            <p class="ticket_author">{% trans "Added by" %} {{ ticket.creator }} <br/>
                {% trans "Last updated" %} {{ ticket.date_edited|date:"d.m.Y H.i" }}</p>

            <table class="ticket_attributes">
                <tr>
                    <th>{% trans "status" %}</th>
                    <td> {{ ticket.status }}</td>
                    <th>{% trans "created" %}</th>
                    <td> {{ ticket.date_created|date:"d.m.Y H.i" }}</td>
                </tr>
                <tr>
                    <th>{% trans "priority" %}</th>
                    <td> {{ ticket.priority }}</td>
                    <th>{% trans "estimated time" %}</th>
                    <td>{{ ticket.estimated_time }}</td>
                </tr>
                <tr>
                    <th>{% trans "assigned to" %}</th>
                    <td>{{ ticket.assigned_to }}</td>
                    <th>{% trans "spent time" %}</th>
                    <td>{{ ticket.spent_time }}</td>
                </tr>
                <tr>
                    <th>{% trans "customer" %}</th>
                    <td>

                        {% if ticket.customer %}
                            <a href="{% url app.customers.views.view ticket.customer.id %}">{{ ticket.customer }}</a>
                        {% endif %}

                    </td>
                </tr>

            </table>

            <div>
                <p><b>{% trans "Description" %}</b></p>

                <p class="ticket_description">{{ ticket.description|linebreaks }}</p>
            </div>

            {% if ticket.attachment %}
                <div>
                    <p><b>{% trans "Attachment" %}</b></p>
                    <a target="_blank" href="{{ ticket.get_attachment_url }}">
                        <img src="{{ STATIC_URL }}img/download.png"
                             style="width:30px; height:30px; vertical-align:middle;">
                        {{ ticket.get_attachment_name }}</a>
                </div>
            {% endif %}
        </div>

    </div>



    <h2>{% trans "History" %}</h2>

    <table>
        {% for update in updates %}

            <tr>
                <td><img
                        src="{{ update.creator.profileImage|thumbnail_with_max_side:"130" }}" class="avatar_img"
                        alt=""/></td>
                <td>
                    <p><strong>{{ update.creator }}</strong> on {{ update.date_created }}</p>

                    <p>
                        {% if update.update_lines.all %}
                            <b>{% trans "Changes: " %}</b>
                            <ul>
                                {% for line in update.update_lines.all %}
                                    <li>{{ line.change }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}

                    </p>

                    {% if update.comment %}
                        <p><b>{% trans "Comment: " %}</b> {{ update.comment }}</p>
                    {% endif %}

                    {% if update.attachment %}
                        <p>
                            <b>{% trans "New Attachment:" %}</b>
                            <a target="_blank" href="{{ update.get_attachment_url }}">
                                <img src="{{ STATIC_URL }}img/download.png"
                                     style="width:30px; height:30px; vertical-align:middle;">
                                {{ update.get_attachment_name }}</a>
                        </p>
                    {% endif %}

                        <form class="visibility_form {% if update.public %} public_visibility {% endif %}">
                            <input type="hidden" value="{{ update.id }}" />
                            {% trans "Public" %}<input type="checkbox" class="visibility_check"
                                    {% if update.public %} checked="checked" {% endif %}/>
                        </form>


                </td>
            </tr>
        {% endfor %}
    </table>

    <script type="text/javascript">

        var visibility_update_url = "{% url app.tickets.views.ajax_change_update_visibility %}"
        $(function() {
            $(".visibility_check").change(function() {
                $("body").css("cursor", "progress");
                var update_id = $(this).prev("input").val();
                var visible = $(this).attr("checked") ? 1 : 0;
                var data = {id: update_id, visible: visible};
                var parent_form = $(this).parent();
                $.post(visibility_update_url, data,
                    function(data) {
                        var visible = data.visible;
                        if (data.visible) {
                            parent_form.addClass("public_visibility");
                        }
                        else {
                            parent_form.removeClass("public_visibility");
                        }
                        $("body").css("cursor", "auto")
                    }, "json" );
            })
        })
    </script>


{% endblock %}