{% extends "base.html" %}
{% load auth %}
{% load i18n %}
{% load tickets_includetags %}

{% block sidebar %}
    {% tickets_sidebar request%}
{% endblock %}

{% block maincontent %}


    <script src="{{ STATIC_URL }}js/quicksearch.js"></script>
    <script>
        $(document).ready(function() {
            $('#filter').quicksearch("#dataTable tbody tr");
        });

    </script>

    <h1>{{ title }}</h1>
    {% tickets_type_filter request %}
    <div class="searchBox">
        <input class="search" type="text" value="" id="filter" placeholder="FiltrÃ©r">
    </div>
    <table id="dataTable">

        <thead>
        <tr>
            <th>{% trans "Tickets" %}</th>
            <th>{% trans "Priority" %}</th>
            <th>{% trans "Updates" %}</th>
            <th>{% trans "Status" %}</th>
            <th>{% trans "Type" %}</th>
            <th>{% trans "Last edited" %}</th>
        </tr>
        </thead>

        <tbody>
        {% for ticket in tickets %}
            <!--
            <tr>
                <td><a href="{% url app.tickets.views.view ticket.id %}">{{ ticket.title }}</a></td>
                <td>{{ ticket.priority }}</td>
                <td>{{ ticket.updates.count }}</td>
                <td>{{ ticket.status }}</td>
                <td>{{ ticket.type }}</td>
                <td>{{ ticket.date_edited|date:"d.m.Y H:i" }}</td>

            </tr>
            -->
        {% endfor %}
        </tbody>
    </table>

    <script type="text/javascript">

        function getTdCell(value) {
            return "<td>" + value + "</td>"
        }


        function getRowFromTicket(ticket) {
            var row = "<tr>";
            row += getTdCell("<a href=\"" + ticket.ticket_url + "\">" + ticket.title +"</a>");
            row += getTdCell(ticket.priority.name);
            row += getTdCell(ticket.update_count);
            row += getTdCell(ticket.status.name);
            row += getTdCell(ticket.type.name);
            row += getTdCell(ticket.date_edited);
            row += "</tr>"
            return row
        }

        function build_table(tickets) {
            var tbody = $("#dataTable tbody");
            tbody.children("tr").remove()
            $(tickets).each(function() {
                tbody.append(getRowFromTicket(this))
            })
        }
        
        function getTickets(type) {
            var type_data = type ? { type_id: parseInt(type)} : {};
            $.get("/api/tickets/", type_data,
            function(data) {
                build_table(data);
            }, "json");
        }

        $(function() {
            getTickets(0);

            $("#type_selection").change(function() {
                var typeId = parseInt($("#type_selection option:selected").val());
                getTickets(typeId)
            })
        })
    </script>


{% endblock %}